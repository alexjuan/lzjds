<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>章丘三维实战指挥系统</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1"/>
    <meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10"/>
    <meta http-equiv="Cache-Control" content="no-store"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <!-- easyUI -->
    <link href="@{'/public/javascripts/easyui-1.4.3/themes/ui-cupertino/easyui.css'}" rel="stylesheet" type="text/css">


    <link href="@{'/public/javascripts/easyui-1.4.3/themes/icon.css'}" rel="stylesheet" type="text/css">
    <script src="@{'/public/SuperMap_iClient3D/examples/js/jquery.min.js'}" type="text/javascript"></script>
    <script src="@{'/public/javascripts/easyui-1.4.3/jquery.easyui.min.js'}" type="text/javascript"></script>
    <script src="@{'/public/javascripts/easyui-1.4.3/locale/easyui-lang-zh_CN.js'}" type="text/javascript"></script>

    <!--  -->
    <link href="@{'/public/stylesheets/index.css'}" rel="stylesheet" type="text/css">
    <script src="@{'/public/javascripts/aceGisMap.js'}"></script>
    <script src="@{'/public/javascripts/index.js'}"></script>
    <!-- 超图 -->
    <link href="@{'/public/SuperMap_iClient3D/Build/Cesium/Widgets/widgets.css'}" rel="stylesheet">
    <link href="@{'/public/SuperMap_iClient3D/examples/css/pretty.css'}" rel="stylesheet">
    <script src="@{'/public/SuperMap_iClient3D/examples/js/slider.js'}"></script>
    <script type="text/javascript" src="@{'/public/SuperMap_iClient3D/examples/js/saveKml.js'}"></script>
    <script type="text/javascript" src="@{'/public/SuperMap_iClient3D/examples/js/sweetalert-dev.js'}"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/tooltip.js'}"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/config.js'}"></script>
    <script type="text/javascript" src="@{'/public/SuperMap_iClient3D/examples/js/require.min.js'}" data-main="/public/SuperMap_iClient3D/examples/js/main"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/Bubble.js'}"></script>

    <link href="@{'/public/SuperMap_iClient3D/Build/Cesium/Widgets/widgets.css'}" rel="stylesheet">
    <link  href="@{'/public/SuperMap_iClient3D/examples/css/font-awesome.min.css'}" rel="stylesheet">
    <link href="@{'/public/SuperMap_iClient3D/examples/css/bootstrap.min.css'}" rel="stylesheet">
    <link href="@{'/public/SuperMap_iClient3D/examples/css/pretty.css'}" rel="stylesheet">
    <link href="@{'/public/SuperMap_iClient3D/examples/css/style.css'}" rel="stylesheet">
    <script src="@{'/public/SuperMap_iClient3D/examples/js/bootstrap.min.js'}"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/bootstrap-select.min.js'}"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/slider.js'}"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/config.js'}"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/tooltip.js'}"></script>
    <script src="@{'/public/SuperMap_iClient3D/examples/js/spectrum.js'}"></script>

    <style>
        #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        .drawCur{
            cursor: url(@{'/public/SuperMap_iClient3D/examples/images/cur/draw.cur'}), auto;
        }
        .twipsy {
            display: none;
        }
        .cesium-viewer-bottom {
            display: none;
        }
        .cesium-viewer-toolbar {
            display: block;
            position: absolute;
            top: 8px;
            left: 42%;
            z-index: 3;
        }
        blockquote {
            display: none;
        }
        .cesium-viewer-geocoderContainer .cesium-geocoder-input {
            background: rgba(0,0,0,0);
            border:1px solid #fff;
            color: #fff;
            border-radius: 10px;
        }
        input::-webkit-input-placeholder {
            color: #fff;
        }
        input:-moz-placeholder {
            color: #fff;
        }
        input::-moz-placeholder {
            color: #fff;
        }
        input:-ms-input-placeholder {
            　　color:#fff;
        }
        .cesium-viewer-geocoderContainer .cesium-geocoder-input:focus{
            background: rgba(0,0,0,0);
            border: 1px solid #fff;
        }
        .cesium-geocoder-searchButton {
            background-color: rgba(0,0,0,0);
            border: 0;
        }
        .cesium-infoBox-visible {
            display: none;
            transform: translate(0,0);
            visibility: visible;
            opacity: 1;
            top:200px;
            right: 600px;
            transition: opacity 0.2s ease-out,transform 0.2s ease-out;
        }
        .bubble {
            text-align: center;
            position: absolute;
            padding: 15px 30px;
            margin: 0;
            color: #fff;
            background: #5a8f00;
            background: -webkit-gradient(linear, 0 0, 0 100%, from(#b8db29), to(#5a8f00));
            background: -moz-linear-gradient(#b8db29, #5a8f00);
            background: -o-linear-gradient(#b8db29, #5a8f00);
            background: linear-gradient(rgba(42,86,152,0.7), rgba(46,136,196,0.7));
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            max-width: 330px;
            max-height: 450px;
        }
        #top_tq_2 {
            float: left;
            display: block;
        }
        #top_tq_3 {
            width: 30px;
            height: 20px;
            float: left;
            margin-top: 4px;
            margin-left: 8px;
        }
        #auto_div {
            display: none;
            width: 250px;
            border: 1px #74c0f9 solid;
            background: rgba(46,136,196,0.7);
            position: absolute;
            top: 40px;
            left: 42%;
            color: #323232;
            z-index: 3;
        }
        .panel-header{
            background-color: #2e3b4d;
        }
        .panel-header {
            background: -webkit-linear-gradient(top,#2e3b4d 0,#2e3b4d 100%);
            background: -moz-linear-gradient(top,#2e3b4d 0,#2e3b4d 100%);
            background: -o-linear-gradient(top,#2e3b4d 0,#2e3b4d 100%);
            background: linear-gradient(to bottom,#2e3b4d 0,#2e3b4d 100%);
        }
        .layout-expand {
            background-color: #2e3b4d;
        }
        .panel-header, .panel-body{
            border-color: #000000;
        }

        .cesium-infoBox{
            left: 10px;
            transform: translate(0,0);
        }

        input[type=range] {
            width: 170px;
        }

        input[type=text] {
            width: 130px;
        }

        label{
            display: inline-block;
            margin: 5px;
            font-weight: bold;
            color: #ffffff;
        }

        .positionAdjust{
            width: 150px;
            margin: 0;
            margin-left: 55px;
            display: inline-block;
            top: -45px;
            position: relative;
        }

    </style>
    <script>
        var handlerPoint,handlerPolygon;
        var defaultUrl = './SuperMap_iClient3D/examples/SampleData/models/springTree.s3m';
        var viewer;
        var scene;
        var isDoubleInfoAdd;    //是否为双实信息标记

        //用于记录模型姿态，并赋予默认值
        var pitch_value_module=0;    //绕X轴旋转
        var roll_value_module=0; //绕Y轴旋转
        var heading_value_module=0;//绕Z轴旋转
        var scale_value_module=1;    //放大比例

        //用于记录摄像机姿态
        var pitch_value_view;    //绕X轴旋转
        var roll_value_view; //绕Y轴旋转
        var heading_value_view;//绕Z轴旋转

        function onload(Cesium) {

            isDoubleInfoAdd=0;  //变量初始化，设置为非双实编辑
             viewer = new Cesium.Viewer('cesiumContainer', {
                geocoder: true,
                terrainProvider: new Cesium.CesiumTerrainProvider({
                    url: URL_CONFIG.STK,
                    requestWaterMask: true,
                    requestVertexNormals: true
                }),
                //添加BingMaps影像服务
                imageryProvider: new Cesium.BingMapsImageryProvider({
                    key: "AjQhMyw76oicHqFz7cUc3qTEy3M2fC2YIbcHjqgyMPuQprNVBr3SsvVdOfmlVc0v",
                    url: URL_CONFIG.BINGMAP
                })
            });

            var infoboxContainer = document.getElementById("bubble");
            viewer.customInfobox = infoboxContainer;
            scene = viewer.scene;
//        var promise = scene.open(URL_CONFIG.SCP_SERVER);
            var imageryLayers = viewer.imageryLayers;
            //初始化天地图全球中文注记服务，并添加至影像图层
            var labelImagery = new Cesium.TiandituImageryProvider({
                mapStyle: Cesium.TiandituMapsStyle.CIA_C//天地图全球中文注记服务（经纬度投影）
            });
            imageryLayers.addImageryProvider(labelImagery);
            //请开发者自行到supermap online官网（http://www.supermapol.com/）申请key
            viewer.geocoder.viewModel.geoKey = '79F9yph6kv8c8I9aARQUxtvn';

            /*----------------------------------------------------HTML+JS操作3D地图end-----------------------------------------------*/

            scene.globe.depthTestAgainstTerrain = false;
            var camera = scene.camera;
            var widget = viewer.cesiumWidget;
            try{
                //打开所发布三维服务下的所有图层
//            var promise2 =  scene.addS3MTilesLayerByScp(URL_CONFIG.SCP_CESHI,{name : '测试'});
                //var promise = scene.open('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace');
                //分区域加载三维模型
                //B1234@ZQPGIS20170426
                //本机服务
                //http://localhost:8090/iserver/services/3D-test/rest/realspace/datas/E0417@zq0417
                var promise =  scene.addS3MTilesLayerByScp('http://localhost:8090/iserver/services/3D-test/rest/realspace/datas/E0417@zq0417/config',{name : 'B1234@ZQPGIS20170426'});
                        //临时注释掉，用本机服务
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/B1234@ZQPGIS20170426/config',{name : 'B1234@ZQPGIS20170426'});
                // //CD0427@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/CD0427@ZQPGIS20170426/config',{name : 'CD0427@ZQPGIS20170426'});
                // //A1234@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/A1234@ZQPGIS20170426/config',{name : 'A1234@ZQPGIS20170426'});
                // //E1E70510@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/E1E70510@ZQPGIS20170426/config',{name : 'E1E70510@ZQPGIS20170426'});
                // //W1Z7@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/W1Z7@ZQPGIS20170426/config',{name : 'W1Z7@ZQPGIS20170426'});
                // //A567@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/A567@ZQPGIS20170426/config',{name : 'A567@ZQPGIS20170426'});
                // //FG@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/FG@ZQPGIS20170426/config',{name : 'FG@ZQPGIS20170426'});
                // //HISTMN@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/HISTMN@ZQPGIS20170426/config',{name : 'HISTMN@ZQPGIS20170426'});
                // //PQROL@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/PQROL@ZQPGIS20170426/config',{name : 'PQROL@ZQPGIS20170426'});
                // //B1234@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/B1234@ZQPGIS20170426/config',{name : 'B1234@ZQPGIS20170426'});
                // //B567@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/B567@ZQPGIS20170426/config',{name : 'B567@ZQPGIS20170426'});
                // //E890@ZQPGIS20170426
                // var promise =  scene.addS3MTilesLayerByScp('http://192.168.1.104:8090/iserver/services/3D-TEST_S3M/rest/realspace/datas/E890@ZQPGIS20170426/config',{name : 'E890@ZQPGIS20170426'});


                Cesium.when(promise,function(layer){
                },function(e){
                    if (widget._showRenderLoopErrors) {
                        var title = '加载SCP失败，请检查网络连接状态或者url地址是否正确？';
                        widget.showErrorPanel(title, undefined, e);
                    }
                });
            }catch(e){
                if (widget._showRenderLoopErrors) {
                    var title = '渲染时发生错误，已停止渲染。';
                    widget.showErrorPanel(title, undefined, e);
                }
            }

            Cesium.when(promise).then(function(){
                camera.setView({
                    destination : Cesium.Cartesian3.fromDegrees(117.515831,36.667711,500),
                    orientation : {
                        heading:500,
                        pitch : 100,
                        roll : 0
                    }
                });

                //----------------------------------------------------------------------------添加模板相关函数---------------------------------------------------------------------------------

                var tooltip = createTooltip(document.body);

                handlerPolygon = new Cesium.DrawHandler(viewer,Cesium.DrawMode.Polygon);
                handlerPolygon.activeEvt.addEventListener(function(isActive){
                    if(isActive == true){
                        viewer.enableCursorStyle = false;
                        viewer._element.style.cursor = '';
                        $('body').removeClass('drawCur').addClass('drawCur');
                    }
                    else{
                        viewer.enableCursorStyle = true;
                        $('body').removeClass('drawCur');
                    }
                });
                handlerPolygon.movingEvt.addEventListener(function(windowPosition){
                    if(windowPosition.x < 210 && windowPosition.y < 120){
                        tooltip.setVisible(false);
                        return ;
                    }
                    if(handlerPolygon.isDrawing){
                        tooltip.showAt(windowPosition,'<p>点击确定压平区域中间点</p><p>右键单击结束绘制</p>');
                    }
                    else{
                        tooltip.showAt(windowPosition,'<p>点击绘制压平区域第一个点</p>');
                    }
                });
                handlerPolygon.drawEvt.addEventListener(function(result){
                    handlerPolygon.polygon.show = false;
                    handlerPolygon.polyline.show = false;
                    var polygon = result.object;
                    var positions = polygon.positions;
                    var flatPoints = [];
                    for(var i = 0,j = positions.length;i < j;i++){
                        var position = positions[i];
                        var cartographic = Cesium.Cartographic.fromCartesian(position);
                        var lon = Cesium.Math.toDegrees(cartographic.longitude);
                        var lat = Cesium.Math.toDegrees(cartographic.latitude);
                        var height = cartographic.height;
                        flatPoints.push(lon);
                        flatPoints.push(lat);
                        flatPoints.push(height);
                    }
                    layer.addFlattenRegion({
                        position : flatPoints,
                        name : 'flatten' + Math.random()
                    });
                    tooltip.setVisible(false);
                    // handlerPolygon.deactivate();
                });

                handlerPoint = new Cesium.DrawHandler(viewer,Cesium.DrawMode.Point);
                handlerPoint.activeEvt.addEventListener(function(isActive){
                    if(isActive == true){
                        viewer.enableCursorStyle = false;
                        viewer._element.style.cursor = '';
                        $('body').removeClass('drawCur').addClass('drawCur');
                    }
                    else{
                        viewer.enableCursorStyle = true;
                        $('body').removeClass('drawCur');
                    }
                });

                handlerPoint.movingEvt.addEventListener(function(windowPosition){
                    if(windowPosition.x < 210 && windowPosition.y < 120){
                        tooltip.setVisible(false);
                        return ;
                    }
                    tooltip.showAt(windowPosition,'<p>点击添加模型</p>');
                });
                var s3mInstanceColc = new Cesium.S3MInstanceCollection(scene._context);
                scene.primitives.add(s3mInstanceColc);
                handlerPoint.drawEvt.addEventListener(function(result){
                    handlerPoint.clear();
                    var point = result.object;
                    var color =  Cesium.Color.WHITE;
                    s3mInstanceColc.add(defaultUrl,{
                        position : point.position,
                        hpr : new Cesium.HeadingPitchRoll(0,0,0),
                        scale : new Cesium.Cartesian3(1,1,1),
                        color : color
                    });
                    var colorStr = color.toCssColorString();
                    viewModel.material = colorStr;
                    $('#colorPicker').css({
                        color : colorStr
                    });
                    $("img").removeClass("selected");
                    handlerPoint && handlerPoint.deactivate();
                    tooltip.setVisible(false);
                });

                document.getElementById("flatten").onclick = function() {
                    handlerPoint && handlerPoint.deactivate();
                    handlerPolygon && handlerPolygon.activate();
                };

                //----------------------------------------------------------------------------添加模板相关函数结束------------------------------------------------------------------------------

            });

            var bVisible = 0;
            $('#btn_2D').click(function(){
                //获取图层，并定义变量
                var B1234 = scene.layers.find("B1234@ZQPGIS20170426");
                var CD0427 = scene.layers.find("CD0427@ZQPGIS20170426");
                var A1234 = scene.layers.find("A1234@ZQPGIS20170426");
                var E1E70510 = scene.layers.find("E1E70510@ZQPGIS20170426");
                var W1Z7 = scene.layers.find("W1Z7@ZQPGIS20170426");
                var A567 = scene.layers.find("A567@ZQPGIS20170426");
                var FG = scene.layers.find("FG@ZQPGIS20170426");
                var HISTMN = scene.layers.find("HISTMN@ZQPGIS20170426");
                var PQROL = scene.layers.find("PQROL@ZQPGIS20170426");
                var B567 = scene.layers.find("B567@ZQPGIS20170426");
                var E890 = scene.layers.find("E890@ZQPGIS20170426");

                if(bVisible==0){
                    B1234.visible=false;
                    CD0427.visible=false;
                    A1234.visible=false;
                    E1E70510.visible=false;
                    W1Z7.visible=false;
                    A567.visible=false;
                    FG.visible=false;
                    HISTMN.visible=false;
                    PQROL.visible=false;
                    B567.visible=false;
                    E890.visible=false;
                }
                else {
                    B1234.visible=true;
                    CD0427.visible=true;
                    A1234.visible=true;
                    E1E70510.visible=true;
                    W1Z7.visible=true;
                    A567.visible=true;
                    FG.visible=true;
                    HISTMN.visible=true;
                    PQROL.visible=true;
                    B567.visible=true;
                    E890.visible=true;
                }

                if(bVisible==0){
                    bVisible=1;
                }
                else {
                    bVisible = 0;
                }

            });
            $('#btn_3D').click(function(){

                //获取图层，并定义变量
                var B1234 = scene.layers.find("B1234@ZQPGIS20170426");
                var CD0427 = scene.layers.find("CD0427@ZQPGIS20170426");
                var A1234 = scene.layers.find("A1234@ZQPGIS20170426");
                var E1E70510 = scene.layers.find("E1E70510@ZQPGIS20170426");
                var W1Z7 = scene.layers.find("W1Z7@ZQPGIS20170426");
                var A567 = scene.layers.find("A567@ZQPGIS20170426");
                var FG = scene.layers.find("FG@ZQPGIS20170426");
                var HISTMN = scene.layers.find("HISTMN@ZQPGIS20170426");
                var PQROL = scene.layers.find("PQROL@ZQPGIS20170426");
                var B567 = scene.layers.find("B567@ZQPGIS20170426");
                var E890 = scene.layers.find("E890@ZQPGIS20170426");

                if(bVisible==0){
                    B1234.visible=false;
                    CD0427.visible=false;
                    A1234.visible=false;
                    E1E70510.visible=false;
                    W1Z7.visible=false;
                    A567.visible=false;
                    FG.visible=false;
                    HISTMN.visible=false;
                    PQROL.visible=false;
                    B567.visible=false;
                    E890.visible=false;
                }
              else {
                    B1234.visible=true;
                    CD0427.visible=true;
                    A1234.visible=true;
                    E1E70510.visible=true;
                    W1Z7.visible=true;
                    A567.visible=true;
                    FG.visible=true;
                    HISTMN.visible=true;
                    PQROL.visible=true;
                    B567.visible=true;
                    E890.visible=true;
                }

                if(bVisible==0){
                    bVisible=1;
                }
                else {
                    bVisible = 0;
                }

            });
            //-----------------------------------------------------------------------------------模型部署相关--------------------------------------------------------------------------------------
            //设置模型选择面板
            document.getElementById("meun_addVideo").onclick = function() {

                var modelPanl = $('#wrapper');

                if(modelPanl.css("display")=="none"){
                    modelPanl.css("display","block");
                }
                else{
                    modelPanl.css("display","none");
                }
            };

            //设置双实选择面板
            document.getElementById("meun_addDoubleInfo").onclick = function() {

                var modelPanl = $('#doubleinfo_wrapper');

                if(modelPanl.css("display")=="none"){
                    modelPanl.css("display","block");
                    isDoubleInfoAdd=1;  //设置为双实编辑状态
                }
                else{
                    modelPanl.css("display","none");
                    isDoubleInfoAdd=0;  //设置为非双实编辑状态
                }
            };

            //设置设备列表
            document.getElementById("meun_listVideo").onclick = function() {
                $("#center_ya_list").window("open");
            };

            var viewModel = {
                heading : 1.0,
                pitch : 1.0,
                roll : 1.0,
                scale : 1.0,
                material : '#ffffff',
            };

            Cesium.knockout.track(viewModel);

            var toolbar = document.getElementById('wrapper');
            Cesium.knockout.applyBindings(viewModel, toolbar);
            Cesium.knockout.getObservable(viewModel,'heading').subscribe(
                function(newValue) {
                    var rotationValue = Cesium.Math.toRadians(newValue);
                    if(viewer.selectedEntity){
                        //为变量赋值

                        heading_value_module=rotationValue;//绕Z轴旋转

                        var instance = viewer.selectedEntity.primitive;
                        var index = viewer.selectedEntity.index;
                        instance.updateRotation(new Cesium.HeadingPitchRoll(rotationValue,0,0),index);
                    }
                }
            );
            Cesium.knockout.getObservable(viewModel,'pitch').subscribe(
                function(newValue) {
                    var rotationValue = Cesium.Math.toRadians(newValue);
                    if(viewer.selectedEntity){
                        //为变量赋值
                        pitch_value_module = rotationValue;

                        var instance = viewer.selectedEntity.primitive;
                        var index = viewer.selectedEntity.index;
                        instance.updateRotation(new Cesium.HeadingPitchRoll(0,rotationValue,0),index);
                    }
                }
            );
            Cesium.knockout.getObservable(viewModel,'roll').subscribe(
                function(newValue) {
                    var rotationValue = Cesium.Math.toRadians(newValue);
                    if(viewer.selectedEntity){

                        //为变量赋值
                        roll_value_module = rotationValue;

                        var instance = viewer.selectedEntity.primitive;
                        var index = viewer.selectedEntity.index;
                        instance.updateRotation(new Cesium.HeadingPitchRoll(0,0,rotationValue),index);
                    }
                }
            );
            Cesium.knockout.getObservable(viewModel,'scale').subscribe(
                function(newValue) {
                    var scale = parseFloat(newValue);
                    if(viewer.selectedEntity){

                        //为变量赋值
                        scale_value_module = scale;

                        var instance = viewer.selectedEntity.primitive;
                        var index = viewer.selectedEntity.index;
                        instance.updateScale(new Cesium.Cartesian3(scale,scale,scale),index);
                    }
                }
            );
            Cesium.knockout.getObservable(viewModel,'material').subscribe(
                function(newValue) {
                    var color = Cesium.Color.fromCssColorString(newValue);
                    if(viewer.selectedEntity){
                        var instance = viewer.selectedEntity.primitive;
                        var index = viewer.selectedEntity.index;
                        instance.updateColor(color,index);
                    }
                }
            );
            Cesium.loadJson("@{'/public/SuperMap_iClient3D/examples/data/models.json'}").then(function(data){
                var result = data.s3mModels;
                for(var i = 0,j = result.length;i < j;i++){
                    addItem(result[i]);
                }
            });

            //调用设备绑定函数，绑定设备列表，同时在地图上展示设备
            bandDevice();


            $("#styleSetting").click(function() {
                if($(".level-one").hasClass("selected")){
                    $(".level-one").removeClass("selected");
                }

                $("#styleSetting").addClass("selected");
                $("#wrapper").show();
                handlerPolygon.deactivate();
            });

            $("#flatten").click(function(){
                if($(".level-one").hasClass("selected")){
                    $(".level-one").removeClass("selected");
                }
                $("#wrapper").hide();
                $("#flatten").addClass("selected");
            })
            $(".close").click(function(){
                $("#wrapper").hide();
                $("#styleSetting").removeClass("selected");
            });
            $("#delete").click(function(){
                if(viewer.selectedEntity){
                    var instance = viewer.selectedEntity.primitive;
                    var index = viewer.selectedEntity.index;
                    instance.updateScale(new Cesium.Cartesian3(0,0,0),index);
                }
            });
            $("#colorPicker").spectrum({
                color: "ffffff",
                showPalette: true,
                showAlpha: true,
                localStorageKey: "spectrum.demo",
                palette: palette
            });


            $("#save_device").click(function(){

                // var pitch_value_module=0;    //绕X轴旋转
                // var roll_value_module=0; //绕Y轴旋转
                // var heading_value_module=0;//绕Z轴旋转
                // var scale_value_module=1;    //放大比例

                var name = $("#name").val();
                var type = $("#TYPE").val();
                var port = $("#port").val();
                var IPadress = $("#IP").val();
                var deviceLink = $("#deviceAddress").val();
                var address = $("#deviceAddress").val();

                var xRoll = pitch_value_module;
                var yRoll = roll_value_module;
                var zRoll = heading_value_module;
                var scale = scale_value_module;

                var lat = $("#Xplus").val();
                var lon = $("#Yplus").val();
                var height=$("#Zplus").val();

                var heading =$("#name").val();
                var pitch = $("#name").val();
                var roll = $("#name").val();

                var remark = $("#remark").val();
                var url = "DeviceController/DeviceSave?name="+name+"&type="+type+"&port="+port+"&IPadress="+IPadress+"&deviceLink="+deviceLink+"&address="+address+"&xRoll="+xRoll+"&yRoll="+yRoll+"&zRoll="+zRoll+"&scale="+scale+"&lat="+lat+"&lon="+lon+"&height="+height+"&heading="+heading+"&pitch="+pitch+"&roll="+roll+"&remark="+remark;
                url = encodeURI(url);//将字符串作为URL进行编码

                //$("#devicelist").   //获取内容标题

                $.ajax({
                    url: url,
                    type: "POST",
                    success: function (data) {
                        if(data.ok){
                            alert('保存成功：'+data.text);
                        }
                    }
                })
            });

            //-----------------------------------------------------------------------------------------------设备列表增删改查相关功能--------------------------------------------------------------------------------
            //设备绑定函数
            function bandDevice() {

                var url = "DeviceController/DeviceQueryAll";
                url = encodeURI(url);//将字符串作为URL进行编码

                //$("#devicelist").   //获取内容标题

                $.ajax({
                    url: url,
                    type: "POST",
                    dataType: "json",
                    success: function (data) {

                        if(data.status==200){

                            $.each(data.list,function (key,val) {

                               //  var htmlcodeStart = "<tr>";
                               //  var htmlcodeContent = "<td class='td_1'>"+val.name+"</td>";
                               //   htmlcodeContent += "<td class='td_1'>"+val.type+"</td>";
                               //  htmlcodeContent += "<td class='td_1'>"+val.deviceAddress+"</td>";
                               //  htmlcodeContent += "<td class='td_1'>"+val.ip+"</td>";
                               //  htmlcodeContent += "<td class='td_1'>"+val.port+"</td>";
                               //  htmlcodeContent += "<td class='td_1'>"+val.remark+"</td>";
                               //  htmlcodeContent += "<td class='td_1'><a href='javascript:void(0)' onclick='locationTest("+val.lon+","+val.lat+","+val.height+")' class='easyui-linkbutton c2 moniyuan' style='width:120px'>定位</a></td>";
                               //  var htmlcodeEnd = "</tr>"
                               // var htmlFull = htmlcodeStart+htmlcodeContent+htmlcodeEnd;
                               //  //document.getElementById("devicelist").append(htmlFull);
                               //  $('#dg tbody').append(htmlFull);
                               //  alert(htmlFull);

                            *{<th data-options="field:'name'" width="20%">设备名称</th>}*
                                        *{<th data-options="field:'type'" width="20%">设备类型</th>}*
                                        *{<th data-options="field:'deviceAddress'" width="20%">设备地址</th>}*
                                        *{<th data-options="field:'ip'" width="20%">IP地址</th>}*
                                        *{<th data-options="field:'port'" width="20%">端口号</th>}*
                                        *{<th data-options="field:'remark'" width="20%">备注</th>}*
                                        *{<th data-options="field:'caozuo'" width="20%">操作</th>}*

                                //绑定数据表
                                $('#dg').datagrid('insertRow',{
                                    row:{
                                        name:val.name,
                                        type:val.type,
                                        deviceAddress:val.address,
                                        ip:val.IPadress,
                                        port:val.port,
                                        remark:val.remark,
                                        caozuo:'<a href=\'javascript:void(0)\' onclick=\'locationTest("+val.lon+","+val.lat+","+val.height+","+val.heading+","+val.pitch+","+val.roll+")\' class=\'easyui-linkbutton c2 moniyuan\' style=\'width:120px\'>定位</a>'
                                    }
                                })

                                //将监控展现在地图上
                                showDevice(val.id,val.name,val.lat,val.lon,val.height,val.xRoll,val.yRoll,val.zRoll,val.scale)

                            })

                        }
                    }
                })
            }
            //在地图上显示设备
            function showDevice(id,name,lat,lon,height,xRoll,yRoll,zRoll,scale) {

                var position = Cesium.Cartesian3.fromDegrees(lon, lat,height);

                var url_device = "@{'/public/ModelData/XFS.gltf'}";

                var entity_XFS1 = viewer.entities.add({
                    id:id,
                    fill : false,
                    outline : true,
                    hpr : new Cesium.HeadingPitchRoll(xRoll,yRoll,zRoll),
                    outlineColor : Cesium.Color.WHITE,
                    name : name,
                    position : position,
                    model : {
                        uri : url_device,
                        scale:scale,
                        maximumScale : 20000
                    }
                });

            }

            //-----------------------------------------------------------------------------------------------设备列表增删改查相关功能--------------------------------------------------------------------------------

            function addItem(data){
                var str = '<a><img style="width: 18%;height: 100%; margin-top:5px; margin-bottom:5px;" src={thumbnail} id={name}></a>'.replace('{thumbnail}',data.thumbnail).replace('{name}', data.name);
                var $el = $('#icons').append(str);
                var $child =$("#"+data.name);
                $child.on('click',function(){
                    defaultUrl = data.path;
                    if($("img").hasClass("selected")){
                        $("img").removeClass("selected");
                        handlerPolygon && handlerPolygon.deactivate();
                    }
                    else{
                        handlerPoint && handlerPoint.activate();
                        $(this).addClass("selected");
                    }
                });
            }


            //模拟现实摄像头

            //消防栓X坐标组

            var lon_XFS1 = [];
            var lat_XFS1 = [];
            var height_XFS1 = [];

            lon_XFS1.push(117.51396443517613);
            lon_XFS1.push(117.51399247189279);
            //消防栓Y坐标组
            lat_XFS1.push(36.666219111447944);
            lat_XFS1.push(36.66523736609509);
            //消防栓Z坐标组
            height_XFS1.push(162.03661908941072);
            height_XFS1.push(185.91589658490378)

            for(var i=0;i<lon_XFS1.length;i++){
                var lon_XFS = lon_XFS1[i];
                var lat_XFS = lat_XFS1[i];
                var height_XFS = height_XFS1[i];
                var position_XFS1 = Cesium.Cartesian3.fromDegrees(lon_XFS, lat_XFS,height_XFS);
                var id1 = 'XFS'+i;

            *{//<script src="@{'/public/SuperMap_iClient3D/examples/js/config.js'}"></script>}*

                var url_XFS1 = "@{'/public/ModelData/XFS.gltf'}";

                var entity_XFS1 = viewer.entities.add({
                    id:id1,
                    fill : false,
                    outline : true,
                    outlineColor : Cesium.Color.WHITE,
                    name : url_XFS1,
                    position : position_XFS1,
                    model : {
                        uri : url_XFS1,
                        scale:10,
                        maximumScale : 20000
                    }
                });

            }

            //-------------------------------------------------------------拾取位置信息开始-----------------------------------

            var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);

            //设置鼠标左键单击回调事件
            handler.setInputAction(function(e) {
                //首先移除之前添加的点
                //viewer.entities.removeAll();

                //获取点击位置笛卡尔坐标
                var position = scene.pickPosition(e.position);

                //将笛卡尔坐标转化为经纬度坐标
                var cartographic = Cesium.Cartographic.fromCartesian(position);

                var longitude = Cesium.Math.toDegrees(cartographic.longitude);
                var latitude = Cesium.Math.toDegrees(cartographic.latitude);
                var height = cartographic.height;
                if(height < 0) {
                    height = 0;
                }

                //为模型文本框赋值
                document.getElementById('Xplus').value=latitude;
                document.getElementById('Yplus').value=longitude;
                document.getElementById('Zplus').value=height;

                //为全局变量，camera参数赋值




                //为双实文本框赋值
                document.getElementById('doubleinfo_Xplus').value=latitude;
                document.getElementById('doubleinfo_Yplus').value=longitude;
                document.getElementById('doubleinfo_Zplus').value=height;


                if(isDoubleInfoAdd==1){

                    //在点击位置添加对应点
                    viewer.entities.add(new Cesium.Entity({
                        point : new Cesium.PointGraphics({
                            color : new Cesium.Color(1, 1, 0),
                            pixelSize : 10,
                            outlineColor : new Cesium.Color(0, 1, 1)
                        }),
                        position : Cesium.Cartesian3.fromDegrees(longitude, latitude , height + 1)
                    }));

                }


                //创建弹出框信息
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            //定义模型选择函数
            /*-------------------------------------------------------点击模型事件------------------------------------------------*/

            //注册鼠标点击事件
            viewer._selectedEntityChanged.addEventListener(function(entity){
                //alert(entity.id);
                // if (entity.id == 'SXT0') {
                //     document.getElementById("video").src = "video/camera.mp4";
                //     $('.DT').toggle(200);
                // }
                var entityID = entity.id;

                alert(entityID);

                if(entityID=="XFS0"){
                    $("#video_list").window("open");
                }
                else if(entityID=="XFS1"){
                    $("#watch_list").window("open");
                }

            });

            //------------------------------------------------------点击模型结束----------------------------------------------------
            $('#loadingbar').remove();

        }

        //飞行函数
        function flytoxy(lon,lat,height,heading,pitch,roll) {

            viewer.camera.flyTo({
                destination: new Cesium.Cartesian3.fromDegrees(lon,lat, height),
                orientation : {
                    pitch : pitch,
                    heading:heading,
                    roll:roll
                }
            });

        }
    </script>
</head>
<body id="vis_body" class="easyui-layout">
<div class="easyui-panel" data-options="region:'center',border:true" id="easyui-panel">
    <div id="auto_div"></div>
    <div id="gdmap" style="width: 100%;height: 100%;z-index: 1;display: none"></div>

    <div id="cesiumContainer">
    </div>
    <!----------------------------------------------------------------------------------------------------------------设备标注相关样式代码------------------------------------------------------->
    <div id="wrapper" style="display:none">
        <div id="login" class="animate form">
            <span class="close" aria-hidden="true">×</span>
            <form>
                <h1 class="title">模型库</h1>
                <p id="icons">
                </p>
                <h1>模型属性编辑</h1>
                <p>
                <div>
                    <label>绕X轴旋转</label><input id="pitch" type="range" min="0" max="360" step="1.0" title="pitch" data-bind="value: pitch, valueUpdate: 'input'">
                </div>
                <div>
                    <label>绕Y轴旋转</label><input id="roll" type="range" min="0" max="360" step="1.0" title="roll" data-bind="value: roll, valueUpdate: 'input'">
                </div>
                <div>
                    <label>绕Z轴旋转</label><input id="heading" type="range" min="0" max="360" step="1.0" title="heading" data-bind="value: heading, valueUpdate: 'input'">
                </div>
                </p>
                <p>
                <div>
                    <label>缩放</label><input type="range" id="scale" min="1" max="10" step="0.1" value="1" title="模型缩放比例" data-bind="value: scale, valueUpdate: 'input'">
                </div>
                </p>
                <p>
                <div>

                    <div>
                        <label>X坐标：</label><input type="text" id="Xplus"  value="0">
                        <label>Y坐标：</label><input type="text" id="Yplus"  value="0">
                        <label>Z高程：</label><input type="text" id="Zplus"  value="0">


                        <label>设备名称：</label><input type="text" id="name"  value="0">
                        <label>设备类型：</label><input type="text" id="TYPE"  value="0">
                        <label>设备地址：</label><input type="text" id="deviceAddress"  value="0">
                        <label>IP地址：</label><input type="text" id="IP"  value="0">
                        <label>端口号：</label><input type="text" id="port"  value="0">
                        <label>备注：</label><input type="text" id="remark"  value="0">

                    </div>
                    <div style="  vertical-align:middle;display:table-cell; ">
                    <button id="delete" style="vertical-align:middle;right:10px;position:relative;top:0;">删除</button> <button id="save_device" style="right:10px;position:relative;top:0;">保存</button>
                    </div>
                </div>
                </p>
            </form>
        </div>
    </div>
    <!----------------------------------------------------------------------------------------------------------------设备标注相关样式代码结束------------------------------------------------------->
    <!----------------------------------------------------------------------------------------------------------------设备标注相关样式代码------------------------------------------------------->
    <div id="doubleinfo_wrapper" style="display:none">
    <!--<div id="doubleinfo_wrapper" style="display:none">-->
        <div id="doubleinfo_login" class="animate form">
            <span class="close" aria-hidden="true">×</span>
            <form>
                <h1 class="title">双实信息标注</h1>
                <p>
                <div>
                <h2 class="title">位置信息</h2>
                    <div>
                        <label>X坐标：</label><input type="text" id="doubleinfo_Xplus"  value="0">
                        <label>Y坐标：</label><input type="text" id="doubleinfo_Yplus"  value="0">
                        <label>Z高程：</label><input type="text" id="doubleinfo_Zplus"  value="0">
                    </div>

                <h2 class="title">双实信息</h2>

                <div >
                    <input id="doubleinfo_ss" class="easyui-searchbox" style="width:300px;alignment: center"
                           data-options="searcher:qq,prompt:'请输入过滤条件'"></input>
                </div>

                <div>

                <ul>
                    <li> <input type="checkbox"/> <a href="javascript:void(0)" onclick="showcontent('20170201')">张三</a></li>
                    <li><input type="checkbox"/> <a href="javascript:void(0)" onclick="showcontent('20170202')">李四</a></li>
                    <li><input type="checkbox"/> <a href="javascript:void(0)" onclick="showcontent('20170203')">王五</a></li>
                </ul>
                </div>

                    <div style="  vertical-align:middle;display:table-cell; ">
                        <button id="doubleinfo_delete" style="vertical-align:middle;right:10px;position:relative;top:0;">删除</button> <button id="doubleinof_save" style="right:10px;position:relative;top:0;">保存</button>
                    </div>
                </div>
                </p>
            </form>
        </div>
    </div>
    <!----------------------------------------------------------------------------------------------------------------设备标注相关样式代码结束------------------------------------------------------->
    <!----------------------------------------------------------------------------------------------------------------设备列表相关代码------------------------------------------------------->
    <div id="center_ya_list" class="easyui-window" title="设备列表" data-options="width:800,height:500,closed:true">
        <table id="dg" class="easyui-datagrid" data-options="width:'100%',height:'100%'"
               toolbar="#toolbar" pagination="true" align="center"
               rownumbers="true" fitColumns="true" singleSelect="true">
            <thead>
            <tr>
                <th data-options="field:'name'" width="20%">设备名称</th>
                <th data-options="field:'type'" width="20%">设备类型</th>
                <th data-options="field:'deviceAddress'" width="20%">设备地址</th>
                <th data-options="field:'ip'" width="20%">IP地址</th>
                <th data-options="field:'port'" width="20%">端口号</th>
                <th data-options="field:'remark'" width="20%">备注</th>
                <th data-options="field:'caozuo'" width="20%">操作</th>
            </tr>
            </thead>
            <tbody>
            *{<tr><td class='td_1'>1</td><td class='td_1'>1</td><td class='td_1'>undefined</td><td class='td_1'>undefined</td><td class='td_1'>1</td><td class='td_1'>1</td><td class='td_1'><a href='javascript:void(0)' onclick='locationTest(1,1,1)' class='easyui-linkbutton c2 moniyuan' style='width:120px'>定位</a></td></tr>}*
            *{<tr><td class='td_1'>2</td><td class='td_1'>2</td><td class='td_1'>undefined</td><td class='td_1'>undefined</td><td class='td_1'>2</td><td class='td_1'>2</td><td class='td_1'><a href='javascript:void(0)' onclick='locationTest(2,2,2)' class='easyui-linkbutton c2 moniyuan' style='width:120px'>定位</a></td></tr>}*
            </tbody>
        </table>
        <div id="toolbar">

            <input id="ss" class="easyui-searchbox" style="width:300px;alignment: center"
                   data-options="searcher:qq,prompt:'请输入需要查询的设备名称'"></input>

        </div>
        <script type="text/javascript">
            function qq(value){
//                alert(value)
            }
            function locationTest(lon,lat,height,heading,pitch,roll) {

                flytoxy(lon,lat,height,heading,pitch,roll);

            }
        </script>
    </div>
    </div>
    <!----------------------------------------------------------------------------------------------------------------设备列表相关代码------------------------------------------------------->

<!----------------------------------------------------------------------------------------------------------------监控设备资源列表------------------------------------------------------->
<div id="video_list" class="easyui-window" title="视频列表" data-options="width:800,height:520,closed:true">

    <div id="video_toolbar">
        <input id="video_ss" class="easyui-searchbox" style="width:300px;alignment: center"
               data-options="searcher:qq,prompt:'请输入过滤条件'"></input>
    </div>

    <div class="easyui-layout" style="width:750px;height:450px;">
        <div region="west" split="true" title="资源区" style="width:250px;height: 450px">
            <p style="padding:5px;margin:0;">请单击播放:</p>
            <ul>
                <li><a href="javascript:void(0)" onclick="showcontent('20170201')">20170201.avi</a></li>
                <li><a href="javascript:void(0)" onclick="showcontent('20170202')">20170202.avi</a></li>
                <li><a href="javascript:void(0)" onclick="showcontent('20170203')">20170203.avi</a></li>
                <li><a href="javascript:void(0)" onclick="showcontent('20170204')">20170204.avi</a></li>
            </ul>
        </div>
        <div id="content" region="center" title="播放区" style="padding:5px;width:500px;height: 450px">

            <video width="320" height="240" controls>
                <source src="@{'public/media/19570002.mp4'}" type="video/mp4">

                您的浏览器不支持 video 标签。
            </video>

        </div>
    </div>

</div>
<!----------------------------------------------------------------------------------------------------------------监控设备资源列表结束------------------------------------------------------->

<!----------------------------------------------------------------------------------------------------------------卡口设备资源列表------------------------------------------------------->
<div id="watch_list" class="easyui-window" title="照片列表" data-options="width:800,height:520,closed:true">

    <div id="watch_toolbar">
        <input id="watch_ss" class="easyui-searchbox" style="width:300px;alignment: center"
               data-options="searcher:qq,prompt:'请输入过滤条件'"></input>
    </div>

    <div class="easyui-layout" style="width:750px;height:450px;">
        <div region="west" split="true" title="资源区" style="width:250px;height: 450px">
            <p style="padding:5px;margin:0;">请单击查看:</p>
            <ul>
                <li><a href="javascript:void(0)" onclick="showcontent('20170201')">20170201.jpg</a></li>
                <li><a href="javascript:void(0)" onclick="showcontent('20170202')">20170202.jpg</a></li>
                <li><a href="javascript:void(0)" onclick="showcontent('20170203')">20170203.jpg</a></li>
                <li><a href="javascript:void(0)" onclick="showcontent('20170204')">20170204.jpg</a></li>
            </ul>
        </div>
        <div id="watch_content"  region="center" title="浏览区" style="padding:5px;width:500px;height: 450px;background:url(@{'public/media/timg.jpg'})">

        </div>
    </div>

</div>
<!----------------------------------------------------------------------------------------------------------------卡口资源列表结束------------------------------------------------------->


    <div id='loadingbar' class="spinner"></div>

</div>

<div class="bottom_btn_2D">
    <button id="btn_2D" class="tb_ya">
        <img src="@{'public/images/2D.png'}" />
    </button>
</div>
<div class="bottom_btn_3D">
    <button id="btn_3D" class="tb_ya">
        <img src="@{'public/images/3D.png'}" />
    </button>
</div>

<div id="menu" data-options="region:'west',split:false,title:'&nbsp;',border:true,width:260">
    <div class="Nav">
        <ul>
            <li class="Nav_li">
                <span class="Nav_Xl">设备信息管理</span>
                <div class="Nav_Two">
                    <label>
                        <span><input type="checkbox" value="" name="" id="meun_addVideo"/>设备标注</span>
                    </label>
                </div>
                <div class="Nav_Two">
                    <label>
                        <span><input type="checkbox" value="" name="" id="meun_listVideo"/>设备列表</span>
                    </label>
                </div>
            </li>
            <li class="Nav_li">
                <span class="Nav_Xl">双实信息管理</span>
                <div class="Nav_Two">
                    <label>
                        <span><input type="checkbox" value="" name="" id="meun_addDoubleInfo"/>双实信息标注</span>
                    </label>
                </div>
            </li>
            <li class="Nav_li">
                <span class="Nav_Xl">案件管理</span>
                <div class="Nav_Two">
                    <label>
                        <span><input type="checkbox" value="" name="" />案件标注</span>
                    </label>
                </div>
                <div class="Nav_Two">
                    <label>
                        <span><input type="checkbox" value="" name="" />案件列表</span>
                    </label>
                </div>
            </li>
            <li class="Nav_li">
                <span class="Nav_Xl">用户管理</span>
                <div class="Nav_Two">
                    <label>
                        <span><input type="checkbox" value="" name="" id="meun_xfd"/>添加用户</span>
                    </label>
                    <label>
                        <span><input type="checkbox" value="" name="" />用户列表</span>
                    </label>

                </div>
            </li>
        </ul>
    </div>
</div>
<div id="banner" data-options="region:'north',border:true,height:80">
    <div class="Top">
        <div class="Top_Logo">
            <img src="@{'public/images/logo.png'}" />
            <span class="Top_Logo_name">章丘三维实战指挥系统</span>
        </div>
        <!--<div id="Top_Search" class="Top_Search">-->
    </div>
</div>
</body>
</html>